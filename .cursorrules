# Compass Calendar Development Rules

You are an expert full-stack developer working on Compass, a calendar application built with React, TypeScript, Node.js, and MongoDB.

## Project Structure

This is a monorepo using Yarn workspaces with the following packages:
- `@compass/web` - React/TypeScript frontend with Redux, styled-components, webpack
- `@compass/backend` - Express.js REST API with MongoDB, Google Calendar sync, WebSocket support
- `@compass/core` - Shared utilities, types, and business logic
- `@compass/scripts` - CLI tools for building, database operations, user management

## Naming Conventions

### React Hooks
- Use camelCase for hook files and their tests
- Good: `useSupertokensAuth.ts` and `useSupertokensAuth.test.ts`
- Good: `useGoogleLogin.ts` and `useGoogleLogin.test.ts`

### TypeScript Files (Non-Hooks)
- Use periods to separate words, not camelCase
- Good: `compass.event.parser.ts` and `compass.event.parser.test.ts`
- Good: `onboarding.storage.util.ts` and `onboarding.storage.util.test.ts`
- Bad: `onboardingStorage.util.ts` (should use periods between words)
- Apply this to all file types: `.util.ts`, `.mapper.ts`, `.parser.ts`, `.service.ts`, `.controller.ts`, etc.

### Boolean Variables
- Always use `is` prefix for boolean variables
- Examples: `isLoading`, `isError`, `isSuccess`, `isVisible`, `isDisabled`

### Barrel Files
- Do NOT use barrel (`index.ts`) files for exports
- Use named exports directly from source files

## Code Style & Best Practices

### React & Frontend (packages/web)
- Follow React best practices and idiomatic patterns
- Write tests using `@testing-library/react` and `@testing-library/user-event`
- Test the way users interact with the application (DOM and user interactions)
- Do NOT use `data-*` attributes or CSS selectors to locate elements in tests
- Use semantic locators and ARIA roles for test selectors
- Avoid mocking when possible; use spies for specific module functions when needed

### Node.js & Backend (packages/backend, packages/core)
- Follow Node.js best practices and idiomatic patterns
- Use async/await for asynchronous operations
- Implement proper error handling

### Module Imports
- Always use module aliased paths for imports when importing Compass modules
- Examples: `@web/components`, `@backend/services`, `@core/types`
- Import order (enforced by Prettier):
  1. Third-party modules
  2. Non-Compass internal modules
  3. `@core/*` modules
  4. `@web/*` modules
  5. `@backend/*` modules
  6. Relative imports

### Styling
- Use Tailwind CSS for all styling
- Use semantic color tokens defined in `packages/web/src/index.css` with `@theme` directive
- Good: `bg-bg-primary`, `text-text-light`, `border-border-primary`
- Bad: `bg-blue-300`, `text-gray-100` (never use raw Tailwind colors)
- Reference semantic tokens: `bg-primary`, `bg-secondary`, `text-primary`, `text-secondary`, etc.

### Validation
- Use Zod for all validation
- Define return types with Zod schemas
- Export types generated from schemas
- Example:
  ```typescript
  import { z } from 'zod';
  
  const UserSchema = z.object({
    id: z.string(),
    email: z.string().email(),
  });
  
  export type User = z.infer<typeof UserSchema>;
  ```

## Testing Requirements

### Before Completing Any Task
- If you changed files in `packages/web`: Run `yarn test:web` (takes ~15 seconds)
- If you changed files in `packages/backend`: Run `yarn test:backend` (takes ~15 seconds)  
- If you changed files in `packages/core`: Run `yarn test:core` (takes ~2 seconds)
- All tests MUST pass before marking work as complete
- Do NOT run `yarn test` (full suite) - it fails in restricted environments due to MongoDB

### Writing Tests
- Place test files next to the code they test with `.test.ts` or `.test.tsx` extension
- Match existing test patterns in the repository
- For web components: Use semantic queries (getByRole, getByLabelText, etc.)
- Avoid implementation details in tests

## Development Workflow

### Initial Setup
- Install dependencies: `yarn install --frozen-lockfile --network-timeout 300000`
  - Takes ~3.5 minutes, NEVER CANCEL, set timeout to 10+ minutes
- Copy environment template: `cp packages/backend/.env.example packages/backend/.env`

### Development Servers
- Web (recommended): `yarn dev:web` - Starts on http://localhost:9080/ in ~10 seconds
- Backend: `yarn dev:backend` - Requires Google OAuth, Supertokens, MongoDB credentials

### Common Commands
- `yarn cli --help` - Shows all CLI commands
- `yarn prettier . --write` - Format all code (takes ~15 seconds)
- `yarn test:core` - Run core tests (takes ~2 seconds)
- `yarn test:web` - Run web tests (takes ~15 seconds)
- `yarn test:backend` - Run backend tests (takes ~15 seconds)

## Branch Naming & Commits

### Branch Naming
Follow the pattern: `type/action-description`

**Types:**
- `feature/` - New features or enhancements
- `bug/` - Bug fixes
- `hotfix/` - Critical production fixes
- `refactor/` - Code refactoring
- `docs/` - Documentation updates

**Examples:**
- `feature/add-calendar-sync`
- `bug/fix-auth-timeout`
- `docs/update-readme`

### Commit Messages
Use conventional commit format: `type(scope): description`

**Types:**
- `feat` - New features
- `fix` - Bug fixes
- `docs` - Documentation changes
- `style` - Code style changes (formatting)
- `refactor` - Code refactoring
- `test` - Adding or updating tests
- `chore` - Maintenance tasks

**Scopes:**
- `web` - Frontend/React changes
- `backend` - Server/API changes
- `core` - Shared utilities/types
- `scripts` - CLI tools

**Rules:**
- Use present tense: "add feature" not "added feature"
- Use lowercase
- Keep under 72 characters
- Be specific and descriptive

**Examples:**
- `feat(web): add calendar event creation modal`
- `fix(backend): resolve authentication timeout issue`
- `docs(readme): update installation instructions`

## Environment Requirements

### Required Environment Variables (backend/.env)
```bash
BASEURL=http://localhost:3000/api
GOOGLE_CLIENT_ID=your_oauth_client_id
GOOGLE_CLIENT_SECRET=your_oauth_secret
SUPERTOKENS_URI=your_supertokens_url
SUPERTOKENS_KEY=your_supertokens_key
MONGO_URI=your_mongodb_connection
PORT=3000
NODE_ENV=development
TZ=Etc/UTC
```

## Key Guidelines

1. When making changes, prefer minimal modifications over extensive refactoring
2. Always run relevant tests before completing a task
3. Use TypeScript strictly - no `any` types unless absolutely necessary
4. Follow existing patterns in the codebase
5. Keep functions small and focused
6. Write self-documenting code with clear variable names
7. Add comments only when necessary to explain complex logic
8. Ensure all async operations have proper error handling
9. Use semantic HTML elements for accessibility
10. Follow accessibility best practices (ARIA labels, keyboard navigation)

## Important Notes

- The backend requires external service credentials to run
- Frontend works standalone without backend services
- Always use UTC timezone for consistency
- Pre-commit hooks run Prettier automatically
- ESLint and Prettier configurations are already set up
- The project uses React 18+ with the new JSX transform

## File Structure Reference

```
packages/
├── backend/src/
│   ├── auth/           # Google OAuth integration
│   ├── calendar/       # Google Calendar API
│   ├── event/          # Event CRUD operations
│   ├── sync/           # Calendar synchronization
│   ├── user/           # User management
│   └── common/         # Shared backend utilities
├── web/src/
│   ├── views/          # React components and pages
│   ├── store/          # Redux state management
│   ├── common/         # Frontend utilities
│   └── assets/         # Images and static files
├── core/src/
│   ├── types/          # TypeScript type definitions
│   ├── constants/      # Shared constants
│   ├── util/           # Utility functions
│   └── mappers/        # Data transformation logic
└── scripts/src/        # CLI tools
```

Always reference these rules first before making code changes. Write clean, maintainable, well-tested code following these established patterns.
